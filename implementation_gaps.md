# 実装乖離分析レポート

**日付**: 2025-12-30
**対象バージョン**: 2.0 (太閤立志伝要素統合版)

本レポートは、設計仕様書 (v2.0) と現在のコードベースの実装状況との間の乖離を詳述するものである。

## 1. 優先度：高（コアメカニクス）

### 1.1 ターン処理と方針（Policy）ロジック
- **要件**: `Design/02_詳細設計書.md` の 3.1.2項 および 6.1項 において、`executeWeekTurn` 関数は `policy` 引数（NORMAL, QUALITY_FIRST, RUSH）を受け取り、それに応じて進捗、品質、スタミナ消費に補正をかける仕様となっている。
- **現状**: `pm-chronicle/src/lib/engine/turnProcessor.ts` の `processTurn` 関数（および内部の `processProjectWeek`）は `policy` 引数を無視している。UI側の `TurnControlPanel` には選択肢が存在するが、エンジン側のロジックと接続されていない。
- **影響**: プレイヤーが毎週選択する戦略的方針が、シミュレーション結果に反映されない。

### 1.2 シミュレーションエンジンの深度（太閤立志伝要素）
- **要件**: `Design/01_外部設計書.md` (F-201, F-202) および `npcSimulator.ts` における、結婚、出産、M&A（企業の合併・買収）のロジック。
- **現状**:
    - `npcSimulator.ts` は、定年退職 (`checkRetirement`)、昇進 (`checkPromotion`)、転職 (`checkJobChange`)、倒産 (`checkBankruptcy`)、死亡のロジックを実装済みである。
    - **未実装**:
        - **結婚・出産**: ゲームループ中に既存NPCが結婚したり子供を設けたりするロジックが欠如している（初期生成時のみ実装されている）。
        - **M&A**: 資金力のある企業が経営難の企業を買収するロジックが欠如しており、倒産ロジックのみが実装されている。
- **影響**: 設計目標である「人生シミュレーション」の要素が不完全となっている。

### 1.3 厳密なAPIエンドポイント
- **要件**: `Design/01_外部設計書.md` の 7.1項 は、AI分析用に `POST /api/v1/analyze` を規定している。
- **現状**: `aiService.ts` は LLMプロバイダー（Ollama, Gemini等）と直接通信するか、柔軟なアダプターパターンを使用しており、厳密なバックエンドエンドポイント `POST /api/v1/analyze` を叩いていない。
- **備考**: これはLocal-Firstアーキテクチャとしては許容範囲の逸脱と考えられるが、外部仕様書とは厳密には一致していない。

## 2. 優先度：中（機能）

### 2.1 日常活動ロジックの統合
- **要件**: `Design/01_外部設計書.md` (F-205) 日常活動（飲み会、清掃など）。
- **現状**: `activities.ts` にデータ定義と `executeActivity` 関数が存在する。しかし、`turnProcessor.ts` はこれを呼び出しておらず、週次ループに「活動フェーズ」が統合されていないように見受けられる。UI側での活動選択・実行がターンループに正しく接続されているか検証が必要である。
- **影響**: 日常活動がメインのゲームループから孤立している可能性がある。

### 2.2 企業生成ロジックの詳細（ベンチャー企業）
- **要件**: 「20社以上（大企業5社、中小15社、ベンチャー5社）」。
- **現状**: `companyGenerator.ts` は企業の生成を行うが、大企業と中小企業の生成ロジックが主である。ベンチャー生成のロジック自体は存在するものの、`worldGenerator.ts`（または暗黙的に使用される箇所）での `generateCompanies` 関数のシグネチャと使用法において、ベンチャー企業の生成数が引数として渡されていない、あるいは別途処理されている可能性がある。

## 3. UI/UXの乖離

### 3.1 入札・提案ロジック
- **要件**: `F-002` 入札（RFP読解、見積もり、プレゼン）。
- **現状**: `ProposalScreen.tsx` は存在する。しかし、設計にあるような複雑な「入札バトル」（プレゼン対決やライバルとの競合）のロジックが、`pm-chronicle/src/lib/proposal.ts`（存在する場合）などで十分に実装されているか不明確である。`turnProcessor.ts` は「実行（Running）」中のプロジェクトに焦点を当てており、「立ち上げ（Initiating）」フェーズのロジックは実行フェーズに比べて作り込みが浅い可能性がある。

## 4. 推奨事項

1.  **`turnProcessor.ts` の更新**: `processTurn` および `processProjectWeek` に `policy` 引数を追加し、方針に基づいた補正（進捗率、スタミナ消費等）を適用すること。
2.  **`npcSimulator.ts` の拡張**: 年次シミュレーションループに `checkMarriage`（結婚判定）、`checkChildbirth`（出産判定）関数を追加すること。
3.  **M&Aの実装**: `npcSimulator.ts` に、資金力のある企業が経営難の企業を買収する `checkAcquisition` ロジックを追加すること。
4.  **活動（Activity）の接続**: `ActivitySelector` が `executeActivity` を呼び出し、グローバルな状態（AP、所持金、能力値）を正しく更新することを確認・修正すること。
