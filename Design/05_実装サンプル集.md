# PMç«‹å¿—ä¼ï¼šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ»ã‚¯ãƒ­ãƒ‹ã‚¯ãƒ« å®Ÿè£…ã‚µãƒ³ãƒ—ãƒ«é›†

**Version**: 1.0  
**Last Updated**: 2025-12-30  
**Document Type**: Implementation Code Samples

> âš ï¸ **æ³¨æ„**: æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯è©³ç´°è¨­è¨ˆæ›¸ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
> å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚ºã§å‚è€ƒã«ã™ã‚‹ãŸã‚ã®TypeScriptã‚³ãƒ¼ãƒ‰ã‚µãƒ³ãƒ—ãƒ«é›†ã§ã™ã€‚
> æ­£å¼ãªè©³ç´°è¨­è¨ˆæ›¸ã¯ `02_è©³ç´°è¨­è¨ˆæ›¸.md` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

---

## 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

### 1.1 ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
pm-chronicle/
â”œâ”€â”€ public/                      # é™çš„ã‚¢ã‚»ãƒƒãƒˆ
â”‚   â”œâ”€â”€ images/                 # ç”»åƒç´ æ
â”‚   â”‚   â”œâ”€â”€ characters/        # ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒ
â”‚   â”‚   â”œâ”€â”€ ui/                # UIã‚¢ã‚¤ã‚³ãƒ³
â”‚   â”‚   â””â”€â”€ backgrounds/       # èƒŒæ™¯ç”»åƒ
â”‚   â”œâ”€â”€ sounds/                # åŠ¹æœéŸ³ãƒ»BGM
â”‚   â””â”€â”€ manifest.json          # PWAè¨­å®š
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.tsx               # ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ App.tsx                # ãƒ«ãƒ¼ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”‚
â”‚   â”œâ”€â”€ components/            # UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”‚   â”œâ”€â”€ common/           # å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ Button.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Modal.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Card.tsx
â”‚   â”‚   â”‚   â””â”€â”€ HexagonChart.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ game/             # ã‚²ãƒ¼ãƒ å›ºæœ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ PMCockpit/   # ãƒ¡ã‚¤ãƒ³ç”»é¢
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ OfficeView.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ GanttChart.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EVMeter.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ CalendarDisplay.tsx
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”œâ”€â”€ CardBattle/   # ã‚«ãƒ¼ãƒ‰ãƒãƒˆãƒ«
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ BattleField.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CardHand.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ DirectNegotiation.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ GaugeDisplay.tsx
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”œâ”€â”€ VacationPuzzle/  # ä¼‘æš‡èª¿æ•´ãƒ‘ã‚ºãƒ«
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CalendarGrid.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MemberBlock.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ NegotiationDialog.tsx
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â””â”€â”€ CharacterSheet/  # ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°
â”‚   â”‚   â”‚       â”œâ”€â”€ StatusDisplay.tsx
â”‚   â”‚   â”‚       â””â”€â”€ TrueNameReveal.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ screens/          # ç”»é¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”‚       â”œâ”€â”€ TitleScreen.tsx
â”‚   â”‚       â”œâ”€â”€ GameSetup.tsx
â”‚   â”‚       â”œâ”€â”€ Dashboard.tsx
â”‚   â”‚       â”œâ”€â”€ ProjectSelect.tsx
â”‚   â”‚       â””â”€â”€ ReportScreen.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/                # ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
â”‚   â”‚   â”œâ”€â”€ useGameState.ts
â”‚   â”‚   â”œâ”€â”€ useProject.ts
â”‚   â”‚   â”œâ”€â”€ useCharacter.ts
â”‚   â”‚   â”œâ”€â”€ useWeekTurn.ts
â”‚   â”‚   â””â”€â”€ useIndexedDB.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ lib/                  # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚   â”œâ”€â”€ engine/          # ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³
â”‚   â”‚   â”‚   â”œâ”€â”€ turnProcessor.ts     # ã‚¿ãƒ¼ãƒ³å‡¦ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ evmCalculator.ts     # EVMè¨ˆç®—
â”‚   â”‚   â”‚   â”œâ”€â”€ eventGenerator.ts    # ã‚¤ãƒ™ãƒ³ãƒˆç”Ÿæˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ troubleResolver.ts   # ãƒˆãƒ©ãƒ–ãƒ«è§£æ±º
â”‚   â”‚   â”‚   â””â”€â”€ aiJudge.ts          # AIåˆ¤å®šï¼ˆç›´è«‡åˆ¤ï¼‰
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ generators/      # ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ worldGenerator.ts    # ä¸–ç•Œç’°å¢ƒç”Ÿæˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ characterGenerator.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ projectGenerator.ts
â”‚   â”‚   â”‚   â””â”€â”€ rivalGenerator.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ calculators/     # å„ç¨®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚   â”‚   â”œâ”€â”€ staminaCalculator.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ progressCalculator.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ qualityCalculator.ts
â”‚   â”‚   â”‚   â””â”€â”€ riskCalculator.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ validators/      # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”‚       â”œâ”€â”€ assignmentValidator.ts
â”‚   â”‚       â””â”€â”€ budgetValidator.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ store/               # çŠ¶æ…‹ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ gameStore.ts     # Zustandã‚¹ãƒˆã‚¢ï¼ˆå…¨ä½“ï¼‰
â”‚   â”‚   â”œâ”€â”€ slices/          # ã‚¹ãƒˆã‚¢ã‚¹ãƒ©ã‚¤ã‚¹
â”‚   â”‚   â”‚   â”œâ”€â”€ worldSlice.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ projectSlice.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ characterSlice.ts
â”‚   â”‚   â”‚   â””â”€â”€ uiSlice.ts
â”‚   â”‚   â””â”€â”€ selectors.ts     # ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼
â”‚   â”‚
â”‚   â”œâ”€â”€ db/                  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
â”‚   â”‚   â”œâ”€â”€ schema.ts        # Dexie.jsã‚¹ã‚­ãƒ¼ãƒå®šç¾©
â”‚   â”‚   â”œâ”€â”€ migrations.ts    # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”‚   â””â”€â”€ repositories/    # ãƒªãƒã‚¸ãƒˆãƒªãƒ‘ã‚¿ãƒ¼ãƒ³
â”‚   â”‚       â”œâ”€â”€ characterRepository.ts
â”‚   â”‚       â”œâ”€â”€ projectRepository.ts
â”‚   â”‚       â””â”€â”€ logRepository.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ services/            # å¤–éƒ¨é€£æºã‚µãƒ¼ãƒ“ã‚¹
â”‚   â”‚   â”œâ”€â”€ aiService.ts     # AI APIé€šä¿¡
â”‚   â”‚   â”œâ”€â”€ exportService.ts # ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
â”‚   â”‚   â””â”€â”€ importService.ts # ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
â”‚   â”‚
â”‚   â”œâ”€â”€ types/               # å‹å®šç¾©
â”‚   â”‚   â”œâ”€â”€ character.ts
â”‚   â”‚   â”œâ”€â”€ project.ts
â”‚   â”‚   â”œâ”€â”€ task.ts
â”‚   â”‚   â”œâ”€â”€ event.ts
â”‚   â”‚   â””â”€â”€ world.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ constants/           # å®šæ•°
â”‚   â”‚   â”œâ”€â”€ gameConstants.ts
â”‚   â”‚   â”œâ”€â”€ cardDefinitions.ts
â”‚   â”‚   â”œâ”€â”€ eventDefinitions.ts
â”‚   â”‚   â””â”€â”€ npcDefinitions.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/               # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â”‚   â”œâ”€â”€ dateUtils.ts
â”‚   â”‚   â”œâ”€â”€ randomUtils.ts
â”‚   â”‚   â”œâ”€â”€ formatUtils.ts
â”‚   â”‚   â””â”€â”€ cryptoUtils.ts   # ãƒã‚§ãƒƒã‚¯ã‚µãƒ ç”Ÿæˆ
â”‚   â”‚
â”‚   â””â”€â”€ styles/              # ã‚¹ã‚¿ã‚¤ãƒ«
â”‚       â”œâ”€â”€ globals.css
â”‚       â””â”€â”€ theme.ts         # Tailwindè¨­å®šæ‹¡å¼µ
â”‚
â”œâ”€â”€ tests/                   # ãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ integration/
â”‚   â””â”€â”€ e2e/
â”‚
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ vite.config.ts
â”œâ”€â”€ tailwind.config.js
â””â”€â”€ README.md
```

---

## 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è©³ç´°è¨­è¨ˆ

### 2.1 IndexedDB ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ï¼ˆDexie.jsï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/db/schema.ts`

```typescript
import Dexie, { Table } from 'dexie';

// å‹å®šç¾©
export interface SaveSlot {
  id: number;                    // 1-5ï¼ˆã‚¹ãƒ­ãƒƒãƒˆç•ªå·ï¼‰
  name: string;                  // ã‚»ãƒ¼ãƒ–å
  createdAt: Date;
  updatedAt: Date;
  worldState: WorldState;
}

export interface WorldState {
  version: string;               // "1.0"
  seed: number;                  // ãƒ©ãƒ³ãƒ€ãƒ ã‚·ãƒ¼ãƒ‰å€¤
  calendar: CalendarState;
  company: CompanyProfile;
  characters: Character[];
  rivals: RivalCompany[];
  partners: BusinessPartner[];
  projects: Project[];
  currentProjectId: string | null;
}

export interface CalendarState {
  currentYear: number;           // 2025
  currentMonth: number;          // 1-12ï¼ˆ4æœˆå§‹ã¾ã‚Šï¼‰
  currentWeek: number;           // ç´¯ç©é€±æ•°
  seasonEvents: SeasonEvent[];   // å¹´é–“ã‚¤ãƒ™ãƒ³ãƒˆ
}

export interface Character {
  id: string;
  name: string;
  ageGroup: '20s' | '30-40s' | '50s+';
  gender: 'male' | 'female' | 'other';
  jobClass: string;
  isUnique: boolean;             // å›ºæœ‰NPCåˆ¤å®š
  
  // ãƒ€ãƒ–ãƒ«ãƒ»ãƒ˜ã‚­ã‚µã‚´ãƒ³
  statsBlue: ProjectSkills;
  statsRed: TeamSkills;
  
  // ä½“åŠ›ã‚·ã‚¹ãƒ†ãƒ 
  stamina: StaminaState;
  
  // ç‰¹æ€§ã‚¿ã‚°
  traits: string[];
  
  // ä¿¡é ¼åº¦ãƒ»è¦šé†’
  trustLevel: number;            // 0-100
  isAwakened: boolean;
  
  // éš ã—ãƒ‡ãƒ¼ã‚¿ï¼ˆè¦šé†’å¾Œé–‹æ”¾ï¼‰
  hiddenData?: {
    trueName: string;
    trueStatsBlue?: Partial<ProjectSkills>;
    trueStatsRed?: Partial<TeamSkills>;
    secretTrait?: string;
  };
  
  // ç¾åœ¨ã®çŠ¶æ…‹
  currentAssignment?: string;    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
  mood: number;                  // å£«æ°—ï¼ˆ0-100ï¼‰
  vacationPlan?: VacationPlan;
}

export interface ProjectSkills {
  design: number;      // 0-10
  develop: number;
  test: number;
  negotiation: number;
  propose: number;
  judgment: number;
}

export interface TeamSkills {
  admin: number;
  organizer: number;
  service: number;
  chat: number;
  charm: number;
  luck: number;
}

export interface StaminaState {
  current: number;
  max: number;
  recoveryRate: number;
  exhaustionDebuff: number;      // è“„ç©ç–²åŠ´ãƒ‡ãƒãƒ•
}

export interface Project {
  id: string;
  name: string;
  clientType: 'existing' | 'new';
  clientCategory: 'private' | 'public';
  domain: string;                // 'é‡‘è', 'åŒ»ç™‚', 'ä¸€èˆ¬'
  
  budget: BudgetState;
  schedule: ScheduleState;
  
  // QCDæŒ‡æ¨™
  qualityScore: number;
  deliveryScore: number;
  costScore: number;
  
  // EVM
  evm: EVMState;
  
  // ã‚¿ã‚¹ã‚¯
  wbs: Task[];
  
  // ãƒªã‚¹ã‚¯ç®¡ç†
  riskRegistry: Risk[];
  
  status: 'PLANNING' | 'RUNNING' | 'COMPLETED' | 'FAILED';
}

export interface Task {
  id: string;
  projectId: string;
  name: string;
  phase: 'REQUIREMENT' | 'DESIGN' | 'DEVELOP' | 'TEST' | 'DEPLOY';
  
  assigneeId: string | null;
  
  // é€²æ—
  progress: number;              // 0-100
  estimatedEffort: number;       // äººæ—¥
  actualEffort: number;
  
  // å“è³ª
  qualityScore: number;          // 0-100
  bugCount: number;
  
  // ãƒªã‚¹ã‚¯
  riskFactor: number;            // 0-100ï¼ˆé«˜ã„ã»ã©å±é™ºï¼‰
  isRiskVisible: boolean;        // åˆ¤æ–­ã‚¹ã‚­ãƒ«ã§å¯è¦–åŒ–
  
  // ä¾å­˜é–¢ä¿‚
  dependencies: string[];        // å…ˆè¡Œã‚¿ã‚¹ã‚¯IDé…åˆ—
  isCriticalPath: boolean;
  
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  isBlocked: boolean;
  blockerReason?: string;
}

export interface WeeklyLog {
  id: string;
  projectId: string;
  week: number;
  
  eventType: 'PROGRESS' | 'TROUBLE' | 'DECISION' | 'NEGOTIATION' | 'VACATION';
  severity: 'info' | 'warning' | 'critical';
  
  title: string;
  description: string;
  
  // AIåˆ†æç”¨
  involvedCharacters: string[];  // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼IDé…åˆ—
  cardsUsed?: string[];          // ä½¿ç”¨ã‚«ãƒ¼ãƒ‰å
  pmChoice?: string;             // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é¸æŠè‚¢
  pmFreeText?: string;           // ç›´è«‡åˆ¤æ™‚ã®å…¥åŠ›
  
  // çµæœ
  impact: {
    budgetChange?: number;
    scheduleChange?: number;
    qualityChange?: number;
    moralChange?: number;
  };
  
  timestamp: Date;
}

// Dexieãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å®šç¾©
export class PMChronicleDB extends Dexie {
  saves!: Table<SaveSlot, number>;
  logs!: Table<WeeklyLog, string>;

  constructor() {
    super('pm_chronicle_db');
    
    this.version(1).stores({
      saves: 'id, updatedAt',
      logs: 'id, projectId, week, eventType',
    });
  }
}

export const db = new PMChronicleDB();
```

### 2.2 localStorage ä½¿ç”¨é …ç›®

**ã‚­ãƒ¼**: `pm_chronicle_settings`

```typescript
interface Settings {
  volume: {
    bgm: number;       // 0-100
    sfx: number;
  };
  graphics: {
    quality: 'low' | 'medium' | 'high';
    animations: boolean;
  };
  gameplay: {
    autoSave: boolean;
    confirmActions: boolean;
    hintsEnabled: boolean;
  };
  lastPlayedSlot: number | null;
}
```

---

## 3. ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯è©³ç´°è¨­è¨ˆ

### 3.1 ã‚¿ãƒ¼ãƒ³å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/lib/engine/turnProcessor.ts`

```typescript
export class TurnProcessor {
  
  /**
   * 1é€±é–“åˆ†ã®ã‚¿ãƒ¼ãƒ³å‡¦ç†ã‚’å®Ÿè¡Œ
   * @param projectId ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
   * @param policy é€±ã®æ–¹é‡ï¼ˆNORMAL | QUALITY_FIRST | RUSHï¼‰
   * @returns é€±æ¬¡çµæœ
   */
  async executeWeekTurn(
    projectId: string,
    policy: WeekPolicy
  ): Promise<WeekResult> {
    
    const project = await getProject(projectId);
    const assignedCharacters = await getAssignedCharacters(projectId);
    
    const dailyResults: DayResult[] = [];
    
    // æœˆæ›œ: åˆæœŸåŒ–
    const monday = this.initializeWeek(project, policy);
    
    // ç«ï½é‡‘: æ—¥æ¬¡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    for (let day = 1; day <= 4; day++) {
      const dayResult = await this.processDaySimulation({
        project,
        characters: assignedCharacters,
        policy,
        dayNumber: day
      });
      
      dailyResults.push(dayResult);
      
      // é‡å¤§ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ™‚ã¯ä¸­æ–­ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä»‹å…¥å¾…ã¡
      if (dayResult.criticalEvent) {
        return {
          status: 'PAUSED',
          pausedAt: day,
          criticalEvent: dayResult.criticalEvent,
          dailyResults
        };
      }
    }
    
    // é‡‘æ›œ: é€±æ¬¡é›†è¨ˆ
    const weekSummary = this.summarizeWeek(project, dailyResults);
    
    // EVMæ›´æ–°
    const updatedEVM = this.updateEVM(project, weekSummary);
    
    // ã‚¹ã‚¿ãƒŸãƒŠå›å¾©å‡¦ç†
    await this.recoverStamina(assignedCharacters);
    
    // ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–
    await this.autoSave(project);
    
    return {
      status: 'COMPLETED',
      summary: weekSummary,
      evm: updatedEVM,
      dailyResults
    };
  }
  
  /**
   * æ—¥æ¬¡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
   */
  private async processDaySimulation(params: DayParams): Promise<DayResult> {
    const { project, characters, policy, dayNumber } = params;
    
    const events: GameEvent[] = [];
    
    for (const task of project.wbs) {
      if (!task.assigneeId) continue;
      
      const character = characters.find(c => c.id === task.assigneeId);
      if (!character) continue;
      
      // é€²æ—è¨ˆç®—
      const progressDelta = this.calculateProgress({
        character,
        task,
        policy
      });
      
      task.progress = Math.min(100, task.progress + progressDelta);
      
      // ã‚¹ã‚¿ãƒŸãƒŠæ¶ˆè²»
      const staminaCost = this.calculateStaminaCost({
        character,
        policy,
        serviceBonus: this.getTeamServiceBonus(characters)
      });
      
      character.stamina.current -= staminaCost;
      
      // ãƒˆãƒ©ãƒ–ãƒ«åˆ¤å®š
      const troubleEvent = this.checkTrouble(task, character);
      if (troubleEvent) {
        // è‡ªå‹•è§£æ±ºå¯èƒ½ã‹åˆ¤å®š
        if (this.canAutoResolve(character, troubleEvent)) {
          const resolved = this.autoResolve(character, troubleEvent);
          events.push(resolved);
        } else {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä»‹å…¥ãŒå¿…è¦
          return {
            events,
            criticalEvent: troubleEvent
          };
        }
      }
      
      // ãƒ©ãƒƒã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆåˆ¤å®š
      const luckyEvent = this.checkLucky(character);
      if (luckyEvent) {
        events.push(luckyEvent);
      }
    }
    
    return { events };
  }
  
  /**
   * é€²æ—è¨ˆç®—
   */
  private calculateProgress(params: ProgressParams): number {
    const { character, task, policy } = params;
    
    // åŸºç¤é€²æ— = ã‚¹ã‚­ãƒ«å€¤
    let baseProgress = this.getRelevantSkill(character, task.phase);
    
    // æ–¹é‡è£œæ­£
    const policyModifier = {
      NORMAL: 1.0,
      QUALITY_FIRST: 0.8,
      RUSH: 1.5
    }[policy];
    
    // ç¾è²Œãƒœãƒ¼ãƒŠã‚¹ï¼ˆå‘¨å›²ã¸ã®å½±éŸ¿ï¼‰
    const charmBonus = character.statsRed.charm * 0.05;
    
    // è¦šé†’ãƒœãƒ¼ãƒŠã‚¹
    const awakeningBonus = character.isAwakened ? 1.2 : 1.0;
    
    // å£«æ°—è£œæ­£
    const moralModifier = character.mood / 100;
    
    const finalProgress = 
      baseProgress * 
      policyModifier * 
      (1 + charmBonus) * 
      awakeningBonus * 
      moralModifier;
    
    return Math.round(finalProgress);
  }
  
  /**
   * ãƒˆãƒ©ãƒ–ãƒ«ç™ºç”Ÿåˆ¤å®š
   */
  private checkTrouble(task: Task, character: Character): GameEvent | null {
    // å“è³ªã‚¹ã‚³ã‚¢ãŒä½ã„ã»ã©ç™ºç”Ÿç‡ä¸Šæ˜‡
    const troubleRate = (100 - task.qualityScore) / 100;
    
    // å¹¸é‹ã§ç„¡åŠ¹åŒ–
    const luckMitigation = character.statsRed.luck / 20; // æœ€å¤§50%è»½æ¸›
    
    const finalRate = troubleRate * (1 - luckMitigation);
    
    if (Math.random() < finalRate) {
      return {
        type: 'TROUBLE',
        severity: task.riskFactor > 70 ? 'critical' : 'warning',
        title: 'ãƒã‚°ç™ºç”Ÿ',
        description: `ã‚¿ã‚¹ã‚¯ã€Œ${task.name}ã€ã§ãƒã‚°ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ`,
        taskId: task.id,
        impact: {
          progressRollback: -10,
          qualityPenalty: -5
        }
      };
    }
    
    return null;
  }
  
  /**
   * è‡ªå‹•è§£æ±ºåˆ¤å®šï¼ˆåˆ¤æ–­ãƒ»ç›´æ„Ÿã‚¹ã‚­ãƒ«ï¼‰
   */
  private canAutoResolve(character: Character, event: GameEvent): boolean {
    const judgmentThreshold = 7;
    return character.statsBlue.judgment >= judgmentThreshold;
  }
}
```

### 3.2 EVMè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/lib/engine/evmCalculator.ts`

```typescript
export class EVMCalculator {
  
  /**
   * EVMæŒ‡æ¨™ã‚’è¨ˆç®—
   */
  calculateEVM(project: Project): EVMState {
    const { wbs, budget, schedule } = project;
    
    // PV (Planned Value): è¨ˆç”»å€¤
    // ç¾åœ¨é€±ã¾ã§ã«å®Œäº†ã—ã¦ã„ã‚‹ã¹ãä½œæ¥­ã®äºˆå®šä¾¡å€¤
    const pv = this.calculatePlannedValue(wbs, schedule.currentWeek);
    
    // EV (Earned Value): å‡ºæ¥é«˜
    // å®Ÿéš›ã«å®Œäº†ã—ãŸä½œæ¥­ã®ä¾¡å€¤
    const ev = this.calculateEarnedValue(wbs);
    
    // AC (Actual Cost): å®Ÿã‚³ã‚¹ãƒˆ
    // å®Ÿéš›ã«æ¶ˆè²»ã—ãŸäºˆç®—
    const ac = budget.initial - budget.current;
    
    // SPI (Schedule Performance Index): ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŠ¹ç‡æŒ‡æ•°
    // 1.0 = äºˆå®šé€šã‚Šã€< 1.0 = é…å»¶ã€> 1.0 = å‰å€’ã—
    const spi = ev / pv;
    
    // CPI (Cost Performance Index): ã‚³ã‚¹ãƒˆåŠ¹ç‡æŒ‡æ•°
    // 1.0 = äºˆç®—é€šã‚Šã€< 1.0 = äºˆç®—è¶…éã€> 1.0 = äºˆç®—å†…
    const cpi = ev / ac;
    
    // VAC (Variance at Completion): å®Œäº†æ™‚å·®ç•°äºˆæ¸¬
    const vac = budget.initial - (ac + (budget.initial - ev) / cpi);
    
    return {
      pv,
      ev,
      ac,
      spi,
      cpi,
      vac,
      status: this.getEVMStatus(spi, cpi)
    };
  }
  
  /**
   * è¨ˆç”»å€¤ã®ç®—å‡º
   */
  private calculatePlannedValue(wbs: Task[], currentWeek: number): number {
    return wbs.reduce((total, task) => {
      // ã‚¿ã‚¹ã‚¯ã®äºˆå®šå®Œäº†é€±ã‚’è¨ˆç®—
      const plannedCompletionWeek = this.getPlannedCompletionWeek(task);
      
      if (currentWeek >= plannedCompletionWeek) {
        // å®Œäº†ã—ã¦ã„ã‚‹ã¹ãã‚¿ã‚¹ã‚¯
        return total + task.estimatedEffort;
      } else {
        // é€²è¡Œä¸­ã‚¿ã‚¹ã‚¯ã®äºˆå®šé€²æ—ç‡
        const plannedProgress = this.getPlannedProgress(task, currentWeek);
        return total + (task.estimatedEffort * plannedProgress / 100);
      }
    }, 0);
  }
  
  /**
   * å‡ºæ¥é«˜ã®ç®—å‡º
   */
  private calculateEarnedValue(wbs: Task[]): number {
    return wbs.reduce((total, task) => {
      return total + (task.estimatedEffort * task.progress / 100);
    }, 0);
  }
  
  /**
   * EVMçŠ¶æ…‹è©•ä¾¡
   */
  private getEVMStatus(spi: number, cpi: number): EVMStatus {
    if (spi >= 0.95 && cpi >= 0.95) {
      return 'HEALTHY';      // ç·‘: å¥å…¨
    } else if (spi >= 0.85 && cpi >= 0.85) {
      return 'WARNING';      // é»„: æ³¨æ„
    } else {
      return 'CRITICAL';     // èµ¤: å±æ©Ÿ
    }
  }
}
```

### 3.3 ä¼‘æš‡èª¿æ•´ãƒ‘ã‚ºãƒ«ãƒ­ã‚¸ãƒƒã‚¯

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/lib/engine/vacationPuzzle.ts`

```typescript
export class VacationPuzzleEngine {
  
  /**
   * ä¼‘æš‡èª¿æ•´ãƒ‘ã‚ºãƒ«ã®ç”Ÿæˆ
   * @param targetPeriod GW, ç›†, æ­£æœˆ
   * @param projectRequirements å¿…è¦ç¨¼åƒæ—¥
   */
  generatePuzzle(
    targetPeriod: 'GW' | 'OBON' | 'NEWYEAR',
    projectRequirements: WorkRequirement[]
  ): VacationPuzzle {
    
    const characters = this.getProjectMembers();
    const calendarDays = this.generateCalendarDays(targetPeriod);
    
    // å„ãƒ¡ãƒ³ãƒãƒ¼ã®å¸Œæœ›ä¼‘ã‚’ç”Ÿæˆ
    const memberBlocks: MemberVacationBlock[] = characters.map(char => {
      return this.generateVacationPreference(char, calendarDays, targetPeriod);
    });
    
    return {
      calendarDays,
      memberBlocks,
      requirements: projectRequirements,
      budget: this.getAvailableBudget(),
      apPool: this.getAvailableAPPool()
    };
  }
  
  /**
   * ãƒ¡ãƒ³ãƒãƒ¼ã®ä¼‘æš‡å¸Œæœ›ã‚’ç”Ÿæˆ
   */
  private generateVacationPreference(
    character: Character,
    days: CalendarDay[],
    period: string
  ): MemberVacationBlock {
    
    const traits = character.traits;
    
    // ä¼‘æš‡é‡è¦–å‹ã¯é•·æœŸé–“ç¢ºä¿
    if (traits.includes('vacation_lover')) {
      return {
        characterId: character.id,
        requestedDays: this.getLongestBlock(days),
        isNegotiable: false,
        lockReason: 'ä¼‘æš‡å–å¾—ã¯è­²ã‚Œã¾ã›ã‚“'
      };
    }
    
    // è¨ˆç”»é‡è¦–å‹ã¯æ—©æœŸç¢ºå®šæ¸ˆã¿
    if (traits.includes('plan_oriented')) {
      return {
        characterId: character.id,
        requestedDays: this.getRandomBlock(days, 5),
        isNegotiable: true,
        negotiationCost: {
          type: 'high_stress',
          description: 'äºˆå®šå¤‰æ›´ã«ã‚ˆã‚‹å¤§ããªã‚¹ãƒˆãƒ¬ã‚¹'
        }
      };
    }
    
    // å ±é…¬é‡è¦–å‹ã¯é‡‘éŠ­ã§è§£æ±ºå¯èƒ½
    if (traits.includes('money_lover')) {
      return {
        characterId: character.id,
        requestedDays: this.getRandomBlock(days, 3),
        isNegotiable: true,
        negotiationCost: {
          type: 'budget',
          amount: 50000 * days.length
        }
      };
    }
    
    // æ¨™æº–å‹
    return {
      characterId: character.id,
      requestedDays: this.getRandomBlock(days, 2),
      isNegotiable: true,
      negotiationCost: {
        type: 'ap',
        amount: 10
      }
    };
  }
  
  /**
   * ãƒ‘ã‚ºãƒ«ã®è§£ç­”å¯èƒ½æ€§ã‚’æ¤œè¨¼
   */
  validateSolution(puzzle: VacationPuzzle, solution: VacationSchedule): ValidationResult {
    
    // å¿…é ˆç¨¼åƒæ—¥ã«èª°ã‚‚é…ç½®ã§ãã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
    for (const req of puzzle.requirements) {
      const availableMembers = this.getAvailableMembers(req.day, solution);
      
      if (availableMembers.length < req.minStaff) {
        return {
          valid: false,
          error: `${req.day}ã«${req.minStaff}åå¿…è¦ã§ã™ãŒã€${availableMembers.length}åã—ã‹ç¢ºä¿ã§ãã¦ã„ã¾ã›ã‚“`
        };
      }
    }
    
    // äºˆç®—ãƒã‚§ãƒƒã‚¯
    const totalCost = this.calculateTotalCost(solution);
    if (totalCost > puzzle.budget) {
      return {
        valid: false,
        error: `äºˆç®—è¶…é: ${totalCost.toLocaleString()}å††ï¼ˆäºˆç®—: ${puzzle.budget.toLocaleString()}å††ï¼‰`
      };
    }
    
    return { valid: true };
  }
}
```

---

## 4. UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°è¨­è¨ˆ

### 4.1 ãƒ€ãƒ–ãƒ«ãƒ»ãƒ˜ã‚­ã‚µã‚´ãƒ³ãƒãƒ£ãƒ¼ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/components/common/HexagonChart.tsx`

```typescript
import React from 'react';
import { ProjectSkills, TeamSkills } from '@/types/character';

interface HexagonChartProps {
  statsBlue: ProjectSkills;
  statsRed: TeamSkills;
  mode: 'blue' | 'red' | 'both';
  size?: number;
}

export const HexagonChart: React.FC<HexagonChartProps> = ({
  statsBlue,
  statsRed,
  mode,
  size = 200
}) => {
  
  const blueLabels = ['è¨­è¨ˆ', 'è£½é€ ', 'è©•ä¾¡', 'æŠ˜è¡', 'ææ¡ˆ', 'åˆ¤æ–­'];
  const redLabels = ['åº¶å‹™', 'å¹¹äº‹', 'çµ¦ä»•', 'é›‘è«‡', 'ç¾è²Œ', 'å¹¸é‹'];
  
  const renderHexagon = (stats: number[], labels: string[], color: string) => {
    const points = calculateHexagonPoints(stats, size);
    
    return (
      <g>
        {/* èƒŒæ™¯ã‚°ãƒªãƒƒãƒ‰ */}
        {[2, 4, 6, 8, 10].map(level => (
          <polygon
            key={level}
            points={calculateHexagonPoints(Array(6).fill(level), size).join(' ')}
            fill="none"
            stroke="#ccc"
            strokeWidth="1"
          />
        ))}
        
        {/* ãƒ‡ãƒ¼ã‚¿ãƒãƒªã‚´ãƒ³ */}
        <polygon
          points={points.join(' ')}
          fill={color}
          fillOpacity="0.3"
          stroke={color}
          strokeWidth="2"
        />
        
        {/* ãƒ©ãƒ™ãƒ« */}
        {labels.map((label, i) => {
          const angle = (Math.PI / 3) * i - Math.PI / 2;
          const x = Math.cos(angle) * (size * 0.6);
          const y = Math.sin(angle) * (size * 0.6);
          
          return (
            <text
              key={i}
              x={x}
              y={y}
              textAnchor="middle"
              fontSize="12"
              fill="#333"
            >
              {label}
            </text>
          );
        })}
      </g>
    );
  };
  
  return (
    <svg width={size * 1.5} height={size * 1.5} viewBox={`-${size * 0.75} -${size * 0.75} ${size * 1.5} ${size * 1.5}`}>
      {(mode === 'blue' || mode === 'both') && 
        renderHexagon(Object.values(statsBlue), blueLabels, '#3b82f6')}
      {(mode === 'red' || mode === 'both') && 
        renderHexagon(Object.values(statsRed), redLabels, '#ef4444')}
    </svg>
  );
};

function calculateHexagonPoints(stats: number[], radius: number): string[] {
  return stats.map((value, i) => {
    const angle = (Math.PI / 3) * i - Math.PI / 2;
    const r = (value / 10) * radius * 0.5;
    const x = Math.cos(angle) * r;
    const y = Math.sin(angle) * r;
    return `${x},${y}`;
  });
}
```

### 4.2 EVMãƒ¡ãƒ¼ã‚¿ãƒ¼

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/components/game/PMCockpit/EVMeter.tsx`

```typescript
import React from 'react';
import { EVMState } from '@/types/project';

interface EVMeterProps {
  evm: EVMState;
}

export const EVMeter: React.FC<EVMeterProps> = ({ evm }) => {
  
  const getColorBySPI = (spi: number): string => {
    if (spi >= 1.0) return '#22c55e';  // ç·‘
    if (spi >= 0.9) return '#eab308';  // é»„
    return '#ef4444';                   // èµ¤
  };
  
  const getNeedleRotation = (value: number): number => {
    // 0.5 ~ 1.5 ã®ç¯„å›²ã‚’ -90deg ~ +90deg ã«ãƒãƒƒãƒ”ãƒ³ã‚°
    const clamped = Math.max(0.5, Math.min(1.5, value));
    return ((clamped - 0.5) / 1.0) * 180 - 90;
  };
  
  return (
    <div className="flex gap-4">
      {/* SPIãƒ¡ãƒ¼ã‚¿ãƒ¼ */}
      <div className="relative">
        <div className="text-xs text-center mb-1">SPI</div>
        <svg width="120" height="80" viewBox="0 0 120 80">
          {/* å††å¼§èƒŒæ™¯ */}
          <path
            d="M 20 60 A 40 40 0 0 1 100 60"
            fill="none"
            stroke="#e5e7eb"
            strokeWidth="8"
          />
          {/* é‡ */}
          <line
            x1="60"
            y1="60"
            x2="60"
            y2="25"
            stroke={getColorBySPI(evm.spi)}
            strokeWidth="3"
            strokeLinecap="round"
            transform={`rotate(${getNeedleRotation(evm.spi)} 60 60)`}
          />
          {/* ä¸­å¿ƒç‚¹ */}
          <circle cx="60" cy="60" r="4" fill="#333" />
          {/* æ•°å€¤è¡¨ç¤º */}
          <text x="60" y="75" textAnchor="middle" fontSize="14" fontWeight="bold">
            {evm.spi.toFixed(2)}
          </text>
        </svg>
      </div>
      
      {/* CPIãƒ¡ãƒ¼ã‚¿ãƒ¼ */}
      <div className="relative">
        <div className="text-xs text-center mb-1">CPI</div>
        <svg width="120" height="80" viewBox="0 0 120 80">
          <path
            d="M 20 60 A 40 40 0 0 1 100 60"
            fill="none"
            stroke="#e5e7eb"
            strokeWidth="8"
          />
          <line
            x1="60"
            y1="60"
            x2="60"
            y2="25"
            stroke={getColorBySPI(evm.cpi)}
            strokeWidth="3"
            strokeLinecap="round"
            transform={`rotate(${getNeedleRotation(evm.cpi)} 60 60)`}
          />
          <circle cx="60" cy="60" r="4" fill="#333" />
          <text x="60" y="75" textAnchor="middle" fontSize="14" fontWeight="bold">
            {evm.cpi.toFixed(2)}
          </text>
        </svg>
      </div>
    </div>
  );
};
```

### 4.3 ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆï¼ˆç°¡æ˜“ç‰ˆï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/components/game/PMCockpit/GanttChart.tsx`

```typescript
import React from 'react';
import { useDndContext, DragOverlay } from '@dnd-kit/core';
import { Task } from '@/types/task';
import { Character } from '@/types/character';

interface GanttChartProps {
  tasks: Task[];
  characters: Character[];
  currentWeek: number;
  onAssignChange: (taskId: string, characterId: string) => void;
}

export const GanttChart: React.FC<GanttChartProps> = ({
  tasks,
  characters,
  currentWeek,
  onAssignChange
}) => {
  
  const renderTaskBar = (task: Task) => {
    const assignee = characters.find(c => c.id === task.assigneeId);
    
    return (
      <div
        key={task.id}
        className={`relative h-8 mb-2 rounded ${
          task.isCriticalPath ? 'border-2 border-red-500' : ''
        }`}
        style={{
          width: `${task.progress}%`,
          backgroundColor: getPhaseColor(task.phase)
        }}
      >
        <div className="flex items-center justify-between px-2 h-full">
          <span className="text-xs text-white truncate">{task.name}</span>
          
          {/* ãƒªã‚¹ã‚¯äºˆå…†ã‚¢ã‚¤ã‚³ãƒ³ */}
          {task.isRiskVisible && task.riskFactor > 70 && (
            <span className="text-red-600" title="é«˜ãƒªã‚¹ã‚¯æ¤œå‡º">ğŸ’€</span>
          )}
          
          {/* ã‚¢ã‚µã‚¤ãƒ³å…ˆ */}
          {assignee && (
            <div 
              className="w-6 h-6 rounded-full bg-white flex items-center justify-center text-xs"
              draggable
              onDragStart={(e) => e.dataTransfer.setData('characterId', assignee.id)}
            >
              {assignee.name[0]}
            </div>
          )}
        </div>
      </div>
    );
  };
  
  return (
    <div className="p-4">
      <div className="text-sm font-bold mb-2">WBSé€²æ—</div>
      {tasks.map(renderTaskBar)}
    </div>
  );
};

function getPhaseColor(phase: string): string {
  const colors = {
    REQUIREMENT: '#10b981',
    DESIGN: '#3b82f6',
    DEVELOP: '#8b5cf6',
    TEST: '#f59e0b',
    DEPLOY: '#ef4444'
  };
  return colors[phase] || '#6b7280';
}
```

---

## 5. AIé€£æºè©³ç´°è¨­è¨ˆ

### 5.1 ç›´è«‡åˆ¤AIåˆ¤å®š

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/lib/engine/aiJudge.ts`

```typescript
import { aiService } from '@/services/aiService';

export class AIJudge {
  
  /**
   * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è‡ªç”±è¨˜è¿°ã‚’è©•ä¾¡
   */
  async evaluateNegotiation(params: NegotiationParams): Promise<NegotiationResult> {
    const { situation, playerInput, opponent } = params;
    
    const prompt = this.buildEvaluationPrompt(situation, playerInput, opponent);
    
    const response = await aiService.analyze(prompt);
    
    // ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼ˆ0-100ï¼‰
    const score = this.parseScore(response);
    
    // è©•ä¾¡ã‚³ãƒ¡ãƒ³ãƒˆæŠ½å‡º
    const feedback = this.parseFeedback(response);
    
    // çµæœåˆ¤å®š
    let result: 'GREAT' | 'GOOD' | 'NORMAL' | 'BAD';
    let effectMultiplier: number;
    
    if (score >= 80) {
      result = 'GREAT';
      effectMultiplier = 3.0;
    } else if (score >= 60) {
      result = 'GOOD';
      effectMultiplier = 2.0;
    } else if (score >= 40) {
      result = 'NORMAL';
      effectMultiplier = 1.0;
    } else {
      result = 'BAD';
      effectMultiplier = -0.5; // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒ€ãƒ¡ãƒ¼ã‚¸
    }
    
    return {
      score,
      result,
      effectMultiplier,
      feedback
    };
  }
  
  private buildEvaluationPrompt(
    situation: string,
    playerInput: string,
    opponent: OpponentProfile
  ): string {
    return `
ã‚ãªãŸã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã®å°‚é–€å®¶ã§ã™ã€‚
ä»¥ä¸‹ã®çŠ¶æ³ã«ãŠã„ã¦ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®èª¬å¾—æ–‡ã‚’3ã¤ã®è¦³ç‚¹ã§è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚

ã€çŠ¶æ³ã€‘
${situation}

ã€ç›¸æ‰‹ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã€‘
- ã‚¿ã‚¤ãƒ—: ${opponent.type}
- é‡è¦–ã™ã‚‹ä¾¡å€¤: ${opponent.values.join(', ')}

ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®èª¬å¾—æ–‡ã€‘
${playerInput}

ã€è©•ä¾¡è¦³ç‚¹ã€‘
1. è«–ç†æ€§ï¼ˆç›¸æ‰‹ã‚’ç´å¾—ã•ã›ã‚‹æ ¹æ‹ ãŒã‚ã‚‹ã‹ï¼‰
2. å…±æ„Ÿæ€§ï¼ˆç›¸æ‰‹ã®ç«‹å ´ã‚’ç†è§£ã—ã¦ã„ã‚‹ã‹ï¼‰
3. ä»£æ›¿æ¡ˆï¼ˆWin-Winã®ææ¡ˆãŒã‚ã‚‹ã‹ï¼‰

å„è¦³ç‚¹ã‚’0-10ç‚¹ã§æ¡ç‚¹ã—ã€åˆè¨ˆç‚¹ã¨æ”¹å–„ææ¡ˆã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

å‡ºåŠ›å½¢å¼ï¼ˆJSONï¼‰:
{
  "logic_score": 8,
  "empathy_score": 7,
  "solution_score": 9,
  "total_score": 80,
  "feedback": "è«–ç†çš„ã§ä»£æ›¿æ¡ˆã‚‚å„ªã‚Œã¦ã„ã¾ã™ã€‚ã•ã‚‰ã«ç›¸æ‰‹ã®æ‡¸å¿µã‚’æ˜ç¤ºçš„ã«è¨€åŠã™ã‚‹ã¨å®Œç’§ã§ã™ã€‚"
}
`;
  }
}
```

### 5.2 æŒ¯ã‚Šè¿”ã‚Šãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/services/aiService.ts`

```typescript
export class AIService {
  
  /**
   * ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæŒ¯ã‚Šè¿”ã‚Šãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
   */
  async generateClosureReport(params: ReportParams): Promise<string> {
    const { project, logs, finalScore } = params;
    
    const prompt = `
ã‚ãªãŸã¯ãƒ™ãƒ†ãƒ©ãƒ³PMãƒ¡ãƒ³ã‚¿ãƒ¼ã§ã™ã€‚
ä»¥ä¸‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ­ã‚°ã‚’åˆ†æã—ã€æ–°äººPMã¸ã®æŒ¯ã‚Šè¿”ã‚Šãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦ã€‘
- åç§°: ${project.name}
- æœŸé–“: ${project.schedule.duration}é€±
- äºˆç®—: ${project.budget.initial.toLocaleString()}å††
- æœ€çµ‚ã‚¹ã‚³ã‚¢: Q=${finalScore.quality} C=${finalScore.cost} D=${finalScore.delivery}

ã€è¡Œå‹•ãƒ­ã‚°ã€‘
${this.formatLogs(logs)}

ã€ãƒ¬ãƒãƒ¼ãƒˆæ§‹æˆã€‘
# ã‚ãªãŸã®PMã‚¹ã‚¿ã‚¤ãƒ«
ï¼ˆè¡Œå‹•å‚¾å‘ã®åˆ†æï¼‰

## é‡è¦ãªæ±ºæ–­
ï¼ˆæˆåŠŸ/å¤±æ•—ã®åˆ†å²ç‚¹ã¨ãªã£ãŸåˆ¤æ–­ã®è§£èª¬ï¼‰

## å­¦ã‚“ã ç”¨èª
ï¼ˆã‚²ãƒ¼ãƒ ä¸­ã«ä½¿ç”¨ã—ãŸPMç”¨èªã®è§£èª¬ï¼‰

## KPT
- Keepï¼ˆè‰¯ã‹ã£ãŸç‚¹ï¼‰
- Problemï¼ˆèª²é¡Œï¼‰
- Tryï¼ˆæ¬¡å›è©¦ã™ã“ã¨ï¼‰

ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã§ã€å…·ä½“çš„ã‹ã¤å®Ÿè·µçš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
`;
    
    const response = await this.callLLMAPI(prompt);
    
    return response;
  }
  
  private formatLogs(logs: WeeklyLog[]): string {
    return logs.map(log => {
      return `Week ${log.week} [${log.eventType}]: ${log.description}${
        log.cardsUsed ? ` (ä½¿ç”¨ã‚«ãƒ¼ãƒ‰: ${log.cardsUsed.join(', ')})` : ''
      }`;
    }).join('\n');
  }
}
```

---

## 6. å®šæ•°ãƒ»ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿

### 6.1 å›ºæœ‰NPCå®šç¾©

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/constants/npcDefinitions.ts`

```typescript
export const UNIQUE_NPCS: UniqueNPC[] = [
  {
    id: 'npc_the_mentor',
    name: 'è‰å£ èª ',
    ageGroup: '50s+',
    gender: 'male',
    jobClass: 'å…ƒå¤§æ‰‹SIer PM',
    
    initialStatsBlue: {
      design: 8,
      develop: 5,
      test: 7,
      negotiation: 10,
      propose: 9,
      judgment: 10
    },
    
    initialStatsRed: {
      admin: 9,
      organizer: 8,
      service: 6,
      chat: 10,
      charm: 7,
      luck: 3
    },
    
    traits: ['veteran', 'mentor', 'slow_adopter'],
    
    hiddenData: {
      trueName: 'ä¼èª¬ã®ç«æ¶ˆã—å±‹',
      description: 'æ•°ã€…ã®ãƒ‡ã‚¹ãƒãƒ¼ãƒã‚’ç”Ÿé‚„ã•ã›ãŸä¼èª¬ã®PM',
      trueStatsBlue: {
        judgment: 10,  // å¤‰åŒ–ãªã—ï¼ˆæ—¢ã«MAXï¼‰
        negotiation: 10
      },
      secretTrait: 'miracle_worker',  // ç‚ä¸Šä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§çœŸä¾¡ç™ºæ®
      unlockCondition: {
        type: 'trust',
        threshold: 80,
        event: 'crisis_rescue'  // ç‚ä¸Šãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å½¼ã®åŠ©è¨€ã«å¾“ã†
      }
    },
    
    personality: {
      description: 'æ¸©åšã ãŒã€é–“é•ã„ã¯å³ã—ãæŒ‡æ‘˜ã™ã‚‹ã€‚ç†è«–ã‚ˆã‚ŠçµŒé¨“ã‚’é‡è¦–ã€‚',
      negotiationStyle: 'logical_empathy',
      stressResponse: 'calm_problem_solver'
    }
  },
  
  {
    id: 'npc_genius_coder',
    name: 'ç™½çŸ³ ãƒªãƒŠ',
    ageGroup: '20s',
    gender: 'female',
    jobClass: 'å¤©æ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢',
    
    initialStatsBlue: {
      design: 9,
      develop: 10,
      test: 8,
      negotiation: 2,
      propose: 10,
      judgment: 4
    },
    
    initialStatsRed: {
      admin: 1,
      organizer: 2,
      service: 3,
      chat: 1,
      charm: 8,
      luck: 9
    },
    
    traits: ['genius', 'solo_player', 'innovation_lover'],
    
    hiddenData: {
      trueName: 'å­¤é«˜ã®é–‹ç™ºè€…',
      description: 'åœ§å€’çš„ãªæŠ€è¡“åŠ›ã ãŒã€ãƒãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ãŒè‹¦æ‰‹',
      trueStatsBlue: {
        develop: 10,
        propose: 10
      },
      trueStatsRed: {
        luck: 9  // å¤©æ‰ã‚†ãˆã®å¼·é‹
      },
      secretTrait: 'code_artist',  // å˜ç‹¬ã‚¿ã‚¹ã‚¯ã§200%åŠ¹ç‡
      unlockCondition: {
        type: 'achievement',
        description: 'å½¼å¥³ã«å˜ç‹¬ã§é›£æ˜“åº¦ã®é«˜ã„ã‚¿ã‚¹ã‚¯ã‚’ã‚¢ã‚µã‚¤ãƒ³ã—ã€å®Œç’§ã«å®Œäº†ã•ã›ã‚‹'
      }
    },
    
    personality: {
      description: 'ä»–äººã«èˆˆå‘³ãŒãªã„ã€‚æŠ€è¡“çš„ã«æ­£ã—ã„ã“ã¨ã‚’æœ€å„ªå…ˆã€‚',
      negotiationStyle: 'logic_only',
      stressResponse: 'silent_resign'  // ã‚¹ãƒˆãƒ¬ã‚¹ã§çªç„¶è¾ã‚ã‚‹
    }
  },
  
  {
    id: 'npc_political_master',
    name: 'é»’å· å¤§è¼”',
    ageGroup: '30-40s',
    gender: 'male',
    jobClass: 'å–¶æ¥­ä¸ŠãŒã‚ŠPM',
    
    initialStatsBlue: {
      design: 3,
      develop: 2,
      test: 4,
      negotiation: 10,
      propose: 8,
      judgment: 7
    },
    
    initialStatsRed: {
      admin: 7,
      organizer: 10,
      service: 9,
      chat: 10,
      charm: 9,
      luck: 6
    },
    
    traits: ['social_master', 'politician', 'smooth_talker'],
    
    hiddenData: {
      trueName: 'ç¤¾å†…æ”¿æ²»ã®é”äºº',
      description: 'æŠ€è¡“ã¯ä½ã„ãŒã€äººè„ˆã¨ãƒ­ãƒ“ãƒ¼æ´»å‹•ã§æ¡ˆä»¶ã‚’æˆåŠŸã•ã›ã‚‹',
      trueStatsRed: {
        chat: 10,
        charm: 10,
        organizer: 10
      },
      secretTrait: 'stakeholder_whisperer',  // ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼äº¤æ¸‰ã§ç„¡æ•µ
      unlockCondition: {
        type: 'event',
        description: 'æ”¿æ²»çš„ã«å›°é›£ãªå±€é¢ã§å½¼ã®äº¤æ¸‰è¡“ã‚’ç›®æ’ƒã™ã‚‹'
      }
    },
    
    personality: {
      description: 'äººå½“ãŸã‚ŠãŒè‰¯ãã€èª°ã¨ã§ã‚‚ä»²è‰¯ããªã‚Œã‚‹ã€‚è£ã§ã¯è¨ˆç®—é«˜ã„ã€‚',
      negotiationStyle: 'win_win_creator',
      stressResponse: 'networking'  // é£²ã¿ä¼šã§è§£æ¶ˆ
    }
  }
];
```

### 6.2 ã‚«ãƒ¼ãƒ‰å®šç¾©

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/constants/cardDefinitions.ts`

```typescript
export const NEGOTIATION_CARDS: Card[] = [
  {
    id: 'scope_creep',
    name: 'ã‚¹ã‚³ãƒ¼ãƒ—ãƒ»ã‚¯ãƒªãƒ¼ãƒ—',
    type: 'DEFENSE',
    cost: 2,
    description: 'ã€Œãã‚Œã¯å¥‘ç´„ç¯„å›²å¤–ã§ã™ã€ã¨æ˜ç¢ºã«æ‹’å¦ã™ã‚‹',
    effect: {
      type: 'BLOCK_ATTACK',
      value: 100,
      targetGauge: 'dissatisfaction'
    },
    pmTermExplanation: 'ã‚¹ã‚³ãƒ¼ãƒ—ãƒ»ã‚¯ãƒªãƒ¼ãƒ—ã¨ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç¯„å›²ãŒç„¡ç§©åºã«æ‹¡å¤§ã™ã‚‹ã“ã¨ã€‚å¤‰æ›´ç®¡ç†ãƒ—ãƒ­ã‚»ã‚¹ã‚’é€šã•ãªã„è¿½åŠ è¦æ±‚ã¯æ˜ç¢ºã«æ–­ã‚‹ã¹ãã€‚'
  },
  
  {
    id: 'tradeoff',
    name: 'ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ææ¡ˆ',
    type: 'NEGOTIATION',
    cost: 3,
    description: 'ã€Œç´æœŸã‚’å„ªå…ˆã™ã‚‹ãªã‚‰ã€ã“ã®æ©Ÿèƒ½ã¯æ¬¡å›ãƒªãƒªãƒ¼ã‚¹ã«ã—ã¾ã—ã‚‡ã†ã€',
    effect: {
      type: 'REDUCE_OPPONENT_ATTACK',
      value: 50,
      addSatisfaction: 30
    },
    pmTermExplanation: 'ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã¨ã¯ã€ä¸€æ–¹ã‚’å¾—ã‚‹ãŸã‚ã«ä»–æ–¹ã‚’çŠ ç‰²ã«ã™ã‚‹ã“ã¨ã€‚PMã¯QCDï¼ˆå“è³ªãƒ»ã‚³ã‚¹ãƒˆãƒ»ç´æœŸï¼‰ã®ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚‹åˆ¤æ–­ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã€‚'
  },
  
  {
    id: 'escalation',
    name: 'ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³',
    type: 'ATTACK',
    cost: 5,
    description: 'ä¸Šå¸ã¾ãŸã¯æ±ºè£æ¨©è€…ã«åˆ¤æ–­ã‚’ä»°ã',
    effect: {
      type: 'HEAVY_DAMAGE',
      value: 80,
      sideEffect: {
        playerReputation: -10,
        description: 'è‡ªåˆ†ã®è©•ä¾¡ãŒå°‘ã—ä¸‹ãŒã‚‹'
      }
    },
    pmTermExplanation: 'ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€è‡ªåˆ†ã®æ¨©é™ã‚’è¶…ãˆã‚‹å•é¡Œã‚’ä¸Šä½è€…ã«ä¸Šã’ã‚‹ã“ã¨ã€‚å¤šç”¨ã™ã‚‹ã¨ã€Œåˆ¤æ–­åŠ›ãŒãªã„ã€ã¨è¦‹ãªã•ã‚Œã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ã€‚'
  },
  
  {
    id: 'psychological_safety',
    name: 'å¿ƒç†çš„å®‰å…¨æ€§ã®ç¢ºä¿',
    type: 'SUPPORT',
    cost: 3,
    description: 'ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã®ç™ºè¨€ã‚’è‚¯å®šã—ã€å£«æ°—ã‚’å›å¾©ã•ã›ã‚‹',
    effect: {
      type: 'HEAL_TEAM',
      value: 40,
      additionalEffect: {
        type: 'MORALE_BOOST',
        duration: 2
      }
    },
    pmTermExplanation: 'å¿ƒç†çš„å®‰å…¨æ€§ã¨ã¯ã€ãƒ¡ãƒ³ãƒãƒ¼ãŒæã‚Œãšã«æ„è¦‹ã‚’è¨€ãˆã‚‹ç’°å¢ƒã€‚Googleã®ç ”ç©¶ã§ã€é«˜ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¼ãƒ ã®æœ€é‡è¦è¦ç´ ã¨åˆ¤æ˜ã€‚'
  },
  
  {
    id: 'direct_negotiation',
    name: 'ç›´è«‡åˆ¤',
    type: 'SPECIAL',
    cost: 10,
    description: 'è‡ªåˆ†ã®è¨€è‘‰ã§ç›¸æ‰‹ã‚’èª¬å¾—ã™ã‚‹ï¼ˆAIåˆ¤å®šï¼‰',
    effect: {
      type: 'VARIABLE',
      aiJudged: true,
      minEffect: -20,  // å¤±æ•—æ™‚ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
      maxEffect: 200   // å¤§æˆåŠŸæ™‚
    },
    pmTermExplanation: 'å®šå‹ã®æ‰‹æ³•ã§ã¯ãªãã€çŠ¶æ³ã«å¿œã˜ãŸç‹¬è‡ªã®èª¬å¾—ã‚’è©¦ã¿ã‚‹ã€‚PMã®çœŸä¾¡ãŒå•ã‚ã‚Œã‚‹ç¬é–“ã€‚'
  }
];
```

---

## 7. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 7.1 IndexedDB ã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³

```typescript
// Bad: æ¯å›DBã‚¢ã‚¯ã‚»ã‚¹
function updateCharacter(id: string, updates: Partial<Character>) {
  const char = await db.characters.get(id);
  await db.characters.put({ ...char, ...updates });
}

// Good: ãƒãƒƒãƒå‡¦ç†
function updateMultipleCharacters(updates: { id: string, data: Partial<Character> }[]) {
  await db.transaction('rw', db.characters, async () => {
    for (const { id, data } of updates) {
      const char = await db.characters.get(id);
      await db.characters.put({ ...char, ...data });
    }
  });
}
```

### 7.2 Reactæœ€é©åŒ–

```typescript
// useMemo ã§ãƒ˜ãƒ“ãƒ¼ãªè¨ˆç®—ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
const ganttData = useMemo(() => {
  return calculateGanttLayout(tasks, currentWeek);
}, [tasks, currentWeek]);

// useCallback ã§ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’å®‰å®šåŒ–
const handleAssignChange = useCallback((taskId: string, charId: string) => {
  updateAssignment(taskId, charId);
}, [updateAssignment]);
```

---

## 8. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### 8.1 ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

**å¯¾è±¡**: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ`src/lib/`ï¼‰

```typescript
// evmCalculator.test.ts
describe('EVMCalculator', () => {
  it('should calculate SPI correctly', () => {
    const calculator = new EVMCalculator();
    const project = createMockProject({
      pv: 100,
      ev: 80
    });
    
    const evm = calculator.calculateEVM(project);
    
    expect(evm.spi).toBe(0.8);
    expect(evm.status).toBe('WARNING');
  });
});
```

### 8.2 çµ±åˆãƒ†ã‚¹ãƒˆ

**å¯¾è±¡**: ã‚¿ãƒ¼ãƒ³å‡¦ç†ãƒ•ãƒ­ãƒ¼

```typescript
describe('Turn Processing Integration', () => {
  it('should complete a full week turn', async () => {
    const processor = new TurnProcessor();
    const projectId = await setupTestProject();
    
    const result = await processor.executeWeekTurn(projectId, 'NORMAL');
    
    expect(result.status).toBe('COMPLETED');
    expect(result.summary.progressDelta).toBeGreaterThan(0);
  });
});
```

---

## 9. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 9.1 XSSå¯¾ç­–

- ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ï¼ˆç›´è«‡åˆ¤ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã¯å…¨ã¦ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
- `dangerouslySetInnerHTML` ã¯ä½¿ç”¨ã—ãªã„

### 9.2 ãƒ‡ãƒ¼ã‚¿æ”¹ã–ã‚“

- ãƒãƒ¼ãƒˆå¯¾ç­–ã¯å®Ÿæ–½ã—ãªã„ï¼ˆæ•™è‚²ç”¨ã®ãŸã‚ï¼‰
- ãŸã ã—ã€JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ã¨ãƒã‚§ãƒƒã‚¯ã‚µãƒ æ¤œè¨¼ã¯å®Ÿæ–½

```typescript
function validateImportData(json: string): ImportValidation {
  const data = JSON.parse(json);
  
  if (data.version !== CURRENT_VERSION) {
    return { valid: false, error: 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸ä¸€è‡´' };
  }
  
  const calculatedChecksum = generateChecksum(data.save_data);
  if (calculatedChecksum !== data.checksum) {
    return { valid: false, error: 'ãƒ‡ãƒ¼ã‚¿ãŒç ´æã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™' };
  }
  
  return { valid: true };
}
```

---

## 10. ä»Šå¾Œã®æ‹¡å¼µè¨­è¨ˆ

### 10.1 ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ†é›¢

å°†æ¥çš„ãªãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤å¯¾å¿œã‚’è¦‹æ®ãˆã€ä»¥ä¸‹ã‚’åˆ†é›¢è¨­è¨ˆï¼š

- ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯: Pure Functionsï¼ˆå‰¯ä½œç”¨ãªã—ï¼‰
- çŠ¶æ…‹ç®¡ç†: Zustandï¼ˆå®¹æ˜“ã«ã‚µãƒ¼ãƒãƒ¼åŒæœŸå¯èƒ½ï¼‰
- UI: Presentational Components

### 10.2 ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ 

ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒŠãƒªã‚ªå¯¾å¿œã®ãŸã‚ã€ä»¥ä¸‹ã‚’JSONå®šç¾©å¯èƒ½ã«ï¼š

- ã‚¤ãƒ™ãƒ³ãƒˆå®šç¾©
- ã‚«ãƒ¼ãƒ‰å®šç¾©
- NPCå®šç¾©

---

**Document End**
